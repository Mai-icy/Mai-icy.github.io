<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>Python异步底层原理 - Mai Icy</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="Mai Icy">
    <meta property="og:title" content="Python异步底层原理"/>
    
<meta name="generator" content="Hexo 6.0.0"></head>

  <body>
    <header>
    <div class="head-title">
        <h4>Mai Icy</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/C/">C</a><a class="category-link" href="/categories/algorithm/">algorithm</a><a class="category-link" href="/categories/python/">python</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
            <a href="/friends">朋友们</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>Python异步底层原理</h2>
            <div class="post-meta">
                <time class="date">2023.10.10</time>
            
                <span class="category"><a class="category-link" href="/categories/python/">python</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <h1 id="Python-异步基础以及原理深层理解"><a href="#Python-异步基础以及原理深层理解" class="headerlink" title="Python 异步基础以及原理深层理解"></a>Python 异步基础以及原理深层理解</h1><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>python的<strong>异步</strong>是基于python的<strong>生成器</strong>机制，利用生成器的特性，可以完成在多个函数之间互相切换。我们可以关注到生成器的一个特性，就是在<code>next</code>了之后，这个函数属于一个暂停状态，如果让多个函数在多次暂停下互相切换，就可以做到异步的效果。</p>
<h4 id="asyncio-异步基础"><a href="#asyncio-异步基础" class="headerlink" title="asyncio 异步基础"></a>asyncio 异步基础</h4><p>关于python异步有几个常见的类型</p>
<ol>
<li>异步函数：通过<code>async def</code>定义的函数，不能直接运行，并且一旦调用就会出现<code>RuntimeWarning</code>，他会返回一个<code>coroutine</code>协程对象。</li>
<li>协程对象(<code>coroutine</code>)：通过异步函数调用获取，包含着程序的行为操作。</li>
<li>任务对象 (<code>Task</code>)：包装了协程对象，便于管理和查看协程对象的执行状态，和控制它的执行，使得协程更容易被管理和监控。</li>
<li><code>Future</code> 对象：是用于表示异步操作结果的对象。它是 <code>asyncio</code> 模块中的一个核心概念，用于表示尚未完成的异步操作</li>
</ol>
<h4 id="关于await的机制"><a href="#关于await的机制" class="headerlink" title="关于await的机制"></a>关于<code>await</code>的机制</h4><p>await后面可以跟上<code>coroutine</code>或者<code>task</code>或者<code>Future</code>，我们现在主要讨论的就是await面对他们进行的行为，我们先讨论两种不同的情况。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">example1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">example2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> task
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>他们有同样的运行结果，通过viztracor，我们可以发现他们的不同。以下分别是example1和example2</p>
<img src="/2023/10/10/asyncio-note/example1.png" class="" title="This is an example image">

<img src="/2023/10/10/asyncio-note/example2.png" class="" title="This is an example image">

<p>可以发现，example1在await之后并没有交出控制权，而是像等待生成器一样等待asyncio结果。而example2则是在await后结束了，并在之后进行sleep，再回到example2。</p>
<h3 id="何为协程的本质，如何做到中间停止"><a href="#何为协程的本质，如何做到中间停止" class="headerlink" title="何为协程的本质，如何做到中间停止"></a>何为协程的本质，如何做到中间停止</h3><p>至于await的具体行为就需要从底层入手</p>
<p>通过dis可见</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"> <span class="token number">9</span>           <span class="token number">0</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">print</span><span class="token punctuation">)</span>
             <span class="token number">2</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
             <span class="token number">4</span> CALL_FUNCTION            <span class="token number">1</span>
             <span class="token number">6</span> POP_TOP

<span class="token number">10</span>           <span class="token number">8</span> LOAD_GLOBAL              <span class="token number">1</span> <span class="token punctuation">(</span>asyncio<span class="token punctuation">)</span>
            <span class="token number">10</span> LOAD_METHOD              <span class="token number">2</span> <span class="token punctuation">(</span>sleep<span class="token punctuation">)</span>
            <span class="token number">12</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">1e-06</span><span class="token punctuation">)</span>
            <span class="token number">14</span> CALL_METHOD              <span class="token number">1</span>
            <span class="token number">16</span> GET_AWAITABLE
            <span class="token number">18</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token number">20</span> YIELD_FROM
            <span class="token number">22</span> POP_TOP

<span class="token number">11</span>          <span class="token number">24</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span><span class="token keyword">print</span><span class="token punctuation">)</span>
            <span class="token number">26</span> LOAD_CONST               <span class="token number">3</span> <span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
            <span class="token number">28</span> CALL_FUNCTION            <span class="token number">1</span>
            <span class="token number">30</span> POP_TOP
            <span class="token number">32</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token number">34</span> RETURN_VALUE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>说明遇到<code>await</code>的时候，运行了<code>GET_AWAITABLE</code>字节码到<code>YIELD_FROM</code>字节码</p>
<h4 id="关于字节码GET-AWAITABLE"><a href="#关于字节码GET-AWAITABLE" class="headerlink" title="关于字节码GET_AWAITABLE"></a>关于字节码<code>GET_AWAITABLE</code></h4><p>先看看<code>GET_AWAITABLE</code>的源码</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">case TARGET(GET_AWAITABLE): &#123;
    PREDICTED(GET_AWAITABLE);
    PyObject *iterable &#x3D; TOP();
    PyObject *iter &#x3D; _PyCoro_GetAwaitableIter(iterable);
	&#x2F;&#x2F; 如果参数是一个&#96;coroutine&#96;，返回coro本身，如果不是则运行并返回&#96;__await__()&#96;函数的值
    if (iter &#x3D;&#x3D; NULL) &#123;
        int opcode_at_minus_3 &#x3D; 0;
        if ((next_instr - first_instr) &gt; 2) &#123;
            opcode_at_minus_3 &#x3D; _Py_OPCODE(next_instr[-3]);
        &#125;
        format_awaitable_error(tstate, Py_TYPE(iterable),
                               opcode_at_minus_3,
                               _Py_OPCODE(next_instr[-2]));
    &#125;

    Py_DECREF(iterable);

    if (iter !&#x3D; NULL &amp;&amp; PyCoro_CheckExact(iter)) &#123;
        PyObject *yf &#x3D; _PyGen_yf((PyGenObject*)iter);
        if (yf !&#x3D; NULL) &#123;
            &#x2F;* &#96;iter&#96; is a coroutine object that is being
                       awaited, &#96;yf&#96; is a pointer to the current awaitable
                       being awaited on. *&#x2F;
            Py_DECREF(yf);
            Py_CLEAR(iter);
            _PyErr_SetString(tstate, PyExc_RuntimeError,
                             &quot;coroutine is being awaited already&quot;);
            &#x2F;* The code below jumps to &#96;error&#96; if &#96;iter&#96; is NULL. *&#x2F;
        &#125;
    &#125;

    SET_TOP(iter); &#x2F;* Even if it&#39;s NULL *&#x2F;

    if (iter &#x3D;&#x3D; NULL) &#123;
        goto error;
    &#125;

    PREDICT(LOAD_CONST);
    DISPATCH();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中的关键函数<code>_PyCoro_GetAwaitableIter</code>的注释说明了：</p>
<p>如果参数是一个<code>coroutine</code>，返回它本身，如果不是则运行并返回<code>__await__</code>函数的值存入<code>iter</code></p>
<p>然后使用了<code>SET_TOP(iter);</code>将其放在了栈顶，以便下次使用。</p>
<h4 id="什么是-await-函数"><a href="#什么是-await-函数" class="headerlink" title="什么是__await__函数"></a>什么是<code>__await__</code>函数</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Future</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""其他代码略"""</span>
    <span class="token keyword">def</span> <span class="token function">__await__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_asyncio_future_blocking <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">yield</span> self  <span class="token comment"># This tells Task to wait for completion.</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"await wasn't used with future"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># May raise too.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>task</code>继承于<code>Future</code>，他们都有这个<code>__await__</code>函数</p>
<ol>
<li>首先，它检查Future对象是否已经完成（即是否具有结果）。如果Future对象已经完成，它会立即返回结果，允许程序继续执行下一步操作。</li>
<li>如果Future对象尚未完成，它将设置<code>self._asyncio_future_blocking</code>属性为True，这是为了告诉任务（Task）对象，当前任务需要等待这个Future对象的完成。然后，它使用<code>yield</code>关键字将自身（即Future对象）返回，暂时挂起当前的协程任务，等待Future对象的完成。</li>
<li>一旦Future对象完成，协程将从之前的挂起点继续执行。在这个时候，Future对象已经完成，<code>self.done()</code>返回True，因此代码将继续执行。</li>
<li>最后，它返回Future对象的结果，如果有的话。</li>
</ol>
<p>可见，<code>__await__</code>可以保证已经完成的任务不再被执行，总之就是做了一个前置的检查，查看任务是否已经完成。</p>
<h4 id="关于字节码YIELD-FROM"><a href="#关于字节码YIELD-FROM" class="headerlink" title="关于字节码YIELD_FROM"></a>关于字节码<code>YIELD_FROM</code></h4><p>现在开始具体分析<code>YIELD_FROM</code>（已手动添加注释）</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">case TARGET(YIELD_FROM): &#123;
    PyObject *v &#x3D; POP();
    PyObject *receiver &#x3D; TOP(); &#x2F;&#x2F; 上次GET_AWAITABLE获取的coro
    int err;
    if (PyGen_CheckExact(receiver) || PyCoro_CheckExact(receiver)) &#123;
        &#x2F;&#x2F; PyGen_CheckExact判断是否是生成器，PyCoro_CheckExact判断是否是coroutine
        retval &#x3D; _PyGen_Send((PyGenObject *)receiver, v);
        &#x2F;&#x2F; 发送一个send，并将yield返回得到的值存入retval
    &#125; else &#123;
        _Py_IDENTIFIER(send);
        if (v &#x3D;&#x3D; Py_None)
            retval &#x3D; Py_TYPE(receiver)-&gt;tp_iternext(receiver);
        else
            retval &#x3D; _PyObject_CallMethodIdOneArg(receiver, &amp;PyId_send, v);
    &#125;
    &#x2F;&#x2F; retval在结束或者出现StopIteration异常就会为NULL
    Py_DECREF(v);
    if (retval &#x3D;&#x3D; NULL) &#123;
        &#x2F;&#x2F; 此处为该coro结束了或者是该coro进行了return
        PyObject *val;
        if (tstate-&gt;c_tracefunc !&#x3D; NULL
            &amp;&amp; _PyErr_ExceptionMatches(tstate, PyExc_StopIteration))
            call_exc_trace(tstate-&gt;c_tracefunc, tstate-&gt;c_traceobj, tstate, f);
        err &#x3D; _PyGen_FetchStopIterationValue(&amp;val); &#x2F;&#x2F; 获取StopIteration内容的值
        if (err &lt; 0)
            goto error;
        Py_DECREF(receiver);
        SET_TOP(val);
        DISPATCH(); &#x2F;&#x2F; 结束这个字节码
    &#125;
    &#x2F;&#x2F; retval 并非NULL，说明生成了一个值现在存在retval中
    
    &#x2F;* receiver remains on stack, retval is value to be yielded *&#x2F;
    f-&gt;f_stacktop &#x3D; stack_pointer;
    &#x2F;* and repeat... *&#x2F;
    assert(f-&gt;f_lasti &gt;&#x3D; (int)sizeof(_Py_CODEUNIT)); &#x2F;&#x2F; 此时的counter应当还没有结束
    f-&gt;f_lasti -&#x3D; sizeof(_Py_CODEUNIT); &#x2F;&#x2F; 调整counter回到上一句指令，下次调用还会从推出位置开始
    goto exiting; &#x2F;&#x2F; 后面的代码省略，大致就是把yield出来得到的值 返回回去
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上说明了一个<code>coroutine</code>是如何让程序在运行到一半的时候停住，实际上和生成器的原理是一样的</p>
<p>并且有个需要注意的语法糖，在协程函数和生成器函数中出现的<code>return</code>的实际原理是raise了一个<code>StopIteration</code>并且把return的值存入这个异常的内容。</p>
<p>这里具体讲述了当await时，发生的具体行为</p>
<h3 id="如何做到并行和相互依赖"><a href="#如何做到并行和相互依赖" class="headerlink" title="如何做到并行和相互依赖"></a>如何做到并行和相互依赖</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Task</span><span class="token punctuation">(</span>futures<span class="token punctuation">.</span>_PyFuture<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _log_destroy_pending <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> coro<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> loop<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>loop<span class="token operator">=</span>loop<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_source_traceback<span class="token punctuation">:</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>_source_traceback<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> coroutines<span class="token punctuation">.</span>iscoroutine<span class="token punctuation">(</span>coro<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_log_destroy_pending <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"a coroutine was expected, got </span><span class="token interpolation"><span class="token punctuation">&#123;</span>coro<span class="token conversion-option punctuation">!r</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> name <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'Task-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>_task_name_counter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_must_cancel <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>_fut_waiter <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_coro <span class="token operator">=</span> coro
        self<span class="token punctuation">.</span>_context <span class="token operator">=</span> contextvars<span class="token punctuation">.</span>copy_context<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>self<span class="token punctuation">.</span>__step<span class="token punctuation">,</span> context<span class="token operator">=</span>self<span class="token punctuation">.</span>_context<span class="token punctuation">)</span>  <span class="token comment"># </span>
        _register_task<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当一个task被创建的时候可见<code>self._loop.call_soon(self.__step, context=self._context)</code></p>
<p>要求事件循环运行函数<code>__step</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>InvalidStateError<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f'_step(): already done: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token conversion-option punctuation">!r</span><span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>exc<span class="token conversion-option punctuation">!r</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_must_cancel<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>exc<span class="token punctuation">,</span> exceptions<span class="token punctuation">.</span>CancelledError<span class="token punctuation">)</span><span class="token punctuation">:</span>
            exc <span class="token operator">=</span> self<span class="token punctuation">.</span>_make_cancelled_error<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_must_cancel <span class="token operator">=</span> <span class="token boolean">False</span>
    coro <span class="token operator">=</span> self<span class="token punctuation">.</span>_coro
    self<span class="token punctuation">.</span>_fut_waiter <span class="token operator">=</span> <span class="token boolean">None</span>

    _enter_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_loop<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
    <span class="token comment"># Call either coro.throw(exc) or coro.send(None).</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> exc <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># We use the `send` method directly, because coroutines</span>
            <span class="token comment"># don't have `__iter__` and `__next__` methods.</span>
            result <span class="token operator">=</span> coro<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># 只会有两种情况，一种是yield了值，此处的值应当是await了一个卡住的任务</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># result即被卡住的任务</span>
            result <span class="token operator">=</span> coro<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>exc<span class="token punctuation">)</span>
    <span class="token keyword">except</span> StopIteration <span class="token keyword">as</span> exc<span class="token punctuation">:</span>  <span class="token comment"># 另一种是 没有卡住的任务了（没有await）结束并返回值</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_must_cancel<span class="token punctuation">:</span>
            <span class="token comment"># Task is cancelled right before coro stops.</span>
            self<span class="token punctuation">.</span>_must_cancel <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cancel<span class="token punctuation">(</span>msg<span class="token operator">=</span>self<span class="token punctuation">.</span>_cancel_message<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>exc<span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token comment"># 设置返回的结果</span>
		<span class="token triple-quoted-string string">"""省略一大段代码"""</span>
            <span class="token keyword">elif</span> blocking<span class="token punctuation">:</span>
                <span class="token keyword">if</span> result <span class="token keyword">is</span> self<span class="token punctuation">:</span>
                    new_exc <span class="token operator">=</span> RuntimeError<span class="token punctuation">(</span>
                        <span class="token string-interpolation"><span class="token string">f'Task cannot await on itself: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token conversion-option punctuation">!r</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>_loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>
                        self<span class="token punctuation">.</span>__step<span class="token punctuation">,</span> new_exc<span class="token punctuation">,</span> context<span class="token operator">=</span>self<span class="token punctuation">.</span>_context<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 如果result存放了我需要await的任务</span>
                    result<span class="token punctuation">.</span>_asyncio_future_blocking <span class="token operator">=</span> <span class="token boolean">False</span>
                    result<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>
                        self<span class="token punctuation">.</span>__wakeup<span class="token punctuation">,</span> context<span class="token operator">=</span>self<span class="token punctuation">.</span>_context<span class="token punctuation">)</span>  <span class="token comment"># 给任务添加回调，希望任务结束之后再唤醒自己</span>
                    self<span class="token punctuation">.</span>_fut_waiter <span class="token operator">=</span> result
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_must_cancel<span class="token punctuation">:</span>
                        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_fut_waiter<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span>
                                msg<span class="token operator">=</span>self<span class="token punctuation">.</span>_cancel_message<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            self<span class="token punctuation">.</span>_must_cancel <span class="token operator">=</span> <span class="token boolean">False</span>
		<span class="token triple-quoted-string string">"""省略一大段代码"""</span>
        _leave_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_loop<span class="token punctuation">,</span> self<span class="token punctuation">)</span>
        self <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># Needed to break cycles when an exception occurs.  # 离开了loop，只有被唤醒才会再被加入</span>
        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>举例子，在A运行的时候await了B，此时的result就是B，A让B完成了之后再叫A，这个标记就是<code>add_done_callback</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add_done_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Add a callback to be run when the future becomes done.

    The callback is called with a single argument - the future object. If
    the future is already done when this is called, the callback is
    scheduled with call_soon.
    """</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token operator">!=</span> _PENDING<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>fn<span class="token punctuation">,</span> self<span class="token punctuation">,</span> context<span class="token operator">=</span>context<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> context <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            context <span class="token operator">=</span> contextvars<span class="token punctuation">.</span>copy_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_callbacks<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在完成的时候源码会有这样一行</p>
<p><code>                super().set_result(exc.value)  # 设置返回的结果</code></p>
<p>负责设置返回结果，同时，这个coroutine也结束了，</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">set_result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Mark the future done and set its result.

    If the future is already done when this method is called, raises
    InvalidStateError.
    """</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_state <span class="token operator">!=</span> _PENDING<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>InvalidStateError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token punctuation">.</span>_state<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>self<span class="token conversion-option punctuation">!r</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>_result <span class="token operator">=</span> result
    self<span class="token punctuation">.</span>_state <span class="token operator">=</span> _FINISHED
    self<span class="token punctuation">.</span>__schedule_callbacks<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结尾调用了<code>self.__schedule_callbacks()</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__schedule_callbacks</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Internal: Ask the event loop to call all callbacks.

    The callbacks are scheduled to be called as soon as possible. Also
    clears the callback list.
    """</span>
    callbacks <span class="token operator">=</span> self<span class="token punctuation">.</span>_callbacks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> callbacks<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    self<span class="token punctuation">.</span>_callbacks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> callback<span class="token punctuation">,</span> ctx <span class="token keyword">in</span> callbacks<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>callback<span class="token punctuation">,</span> self<span class="token punctuation">,</span> context<span class="token operator">=</span>ctx<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此处就是运行了我们<code>add_done_callback</code>加入的<code>__wake</code>，唤醒了被卡住的那个coroutine。</p>
<p>至此也就解释了互相依赖的原理。</p>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2023/10/18/io-multiplexing-linux-note/">IO多路复用——Linux</a></li>
                
                
                    <li>下一篇: <a href="/2023/09/02/c-primer-plus-note2/">C Primer Plus 笔记2</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/%E5%BC%82%E6%AD%A5-%E5%BA%95%E5%B1%82/" rel="tag">异步 底层</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://sdn.geekzu.org/avatar/b4bb31de44ce157568a6b61fa63ebfd8?s=80" alt="Mai Icy" />
            </figure>
        
            <div class="author-info">
                <h4>Mai Icy</h4>
                <p>wwwwwww</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/03/16/learn-algorithm-note8/">算法学习笔记8——同余</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/10/acm-class-note8/">ACM程序课算法笔记8——二分答案</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/31/learn-algorithm-note7/">算法学习笔记7——根号分治</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/05/learn-database-note2/">《How does a relational database work》阅读笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/28/learn-algorithm-note6/">算法学习笔记6——ST表</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/26/learn-algorithm-note5/">算法学习笔记5——异或哈希</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/C/" style="font-size: 13.33px;">C</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/python-requests/" style="font-size: 13.33px;">python requests</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/%E5%9B%BE%E7%AE%97%E6%B3%95/" style="font-size: 16.67px;">图算法</a> <a href="/tags/%E5%BC%82%E6%AD%A5-%E5%BA%95%E5%B1%82/" style="font-size: 10px;">异步 底层</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10px;">数据结构</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 20px;">算法</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/" style="font-size: 10px;">网络爬虫</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">Mai Icy</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":true,"night":true});</script>

  </body>
</html>
